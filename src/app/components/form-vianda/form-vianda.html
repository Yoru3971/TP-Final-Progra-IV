<form class="form-vianda" [formGroup]="formVianda">
  <div class="form-layout">
    <div class="form-fields-left">
      <!-- Nombre Vianda -->
      <div class="form-field">
        <label for="nombreVianda" class="form-label">Nombre de la Vianda</label>
        <input
          formControlName="nombreVianda"
          type="text"
          class="form-input"
          placeholder="Ej: Milanesa con pur√©"
        />

        @if (formVianda.get('nombreVianda')?.invalid && (formVianda.get('nombreVianda')?.dirty ||
        formVianda.get('nombreVianda')?.touched)) {
        <div class="error-messages">
          @if (formVianda.get('nombreVianda')?.hasError('required')) {
          <p>El nombre es obligatorio.</p>
          } @if (formVianda.get('nombreVianda')?.hasError('maxLength')) {
          <p>M√°ximo 255 caracteres.</p>
          }
        </div>
        }
      </div>

      <!-- Categoria -->
      <div class="form-field">
        <label for="categoria" class="form-label">Categor√≠a</label>

        <select formControlName="categoria" class="form-input">
          <option [ngValue]="null">--Seleccione--</option>

          @for (cat of categorias; track cat.key) {
          <option [value]="cat.key">{{ cat.label }}</option>
          }
        </select>

        @if (formVianda.get('categoria')?.invalid && (formVianda.get('categoria')?.dirty ||
        formVianda.get('categoria')?.touched)) {
        <div class="error-messages">
          @if (formVianda.get('categoria')?.hasError('required')) {
          <p>Debe seleccionar una categor√≠a.</p>
          }
        </div>
        }
      </div>

      <!-- Descripcion -->
      <div class="form-field">
        <label for="descripcion" class="form-label">Descripci√≥n</label>
        <textarea
          formControlName="descripcion"
          class="form-input"
          placeholder="Ej: Porci√≥n abundante con guarnici√≥n"
        ></textarea>

        @if (formVianda.get('descripcion')?.invalid && (formVianda.get('descripcion')?.dirty ||
        formVianda.get('descripcion')?.touched)) {
        <div class="error-messages">
          @if (formVianda.get('descripcion')?.hasError('required')) {
          <p>La descripci√≥n es obligatoria.</p>
          } @if (formVianda.get('descripcion')?.hasError('maxLength')) {
          <p>M√°ximo 400 caracteres.</p>
          }
        </div>
        }
      </div>

      <!-- Precio -->
      <div class="form-field">
        <label for="precio" class="form-label">Precio</label>
        <input formControlName="precio" type="number" class="form-input" placeholder="Ej: 3500" />

        @if (formVianda.get('precio')?.invalid && (formVianda.get('precio')?.dirty ||
        formVianda.get('precio')?.touched)) {
        <div class="error-messages">
          @if (formVianda.get('precio')?.hasError('required')) {
          <p>El precio es obligatorio.</p>
          } @if (formVianda.get('precio')?.hasError('min')) {
          <p>Debe ser mayor a 0.</p>
          }
        </div>
        }
      </div>

      <!-- Checkboxes -->
      <div class="form-field checkbox-group">
        <label class="checkbox-container">
          <input type="checkbox" formControlName="esVegano" />
          <span>Vegano</span>
        </label>

        <label class="checkbox-container">
          <input type="checkbox" formControlName="esVegetariano" />
          <span>Vegetariano</span>
        </label>

        <label class="checkbox-container">
          <input type="checkbox" formControlName="esSinTacc" />
          <span>Sin TACC</span>
        </label>
      </div>
    </div>
    <!-- Fin .form-fields-left -->

    <div class="image-upload-right">
      <div class="form-field custom-file-field">
        <!-- Input de archivo (oculto). Usamos #fileInput para la referencia en TS -->
        <input
          type="file"
          id="imagen-file"
          #fileInput
          (change)="onFileSelected($event); onFileInputReady(fileInput)"
          class="form-file-input"
          accept="image/jpeg, image/png, image/webp"
        />

        <!-- Contenedor Visual (Caja de Imagen). El <label> activa el input file. -->
        <label for="imagen-file" class="upload-box-visual" [class.has-preview]="!!imagePreviewUrl">
          @if (imagePreviewUrl) {
          <!-- PREVISUALIZACI√ìN DE LA IMAGEN (si hay URL) -->
          <div
            class="image-preview"
            [style.background-image]="'url(' + imagePreviewUrl + ')'"
          ></div>

          <!-- BOT√ìN DE ELIMINAR (solo visible si hay imagen) -->
          <button
            type="button"
            class="btn-remove-image"
            (click)="removeImage(); $event.preventDefault()"
          >
            <!-- Icono de tacho de basura (usando Font Awesome o un car√°cter) -->
            üóëÔ∏è
          </button>

          } @else {
          <!-- √çCONO y TEXTO DE PLACEHOLDER (si NO hay URL) -->
          <span class="upload-icon">‚§í</span>
          <br />
          <span class="upload-text">Cargar imagen</span>
          }
        </label>

        <!-- Mensaje de estado/error debajo del recuadro -->
        <div class="image-placeholder-message">
          @if (formVianda.get('image')?.invalid && (formVianda.get('image')?.dirty ||
          formVianda.get('image')?.touched)) {
          <!-- Mensaje de error de validaci√≥n -->
          <div class="error-messages">
            @if (formVianda.get('image')?.hasError('required')) {
            <p>La imagen es obligatoria.</p>
            }
            <!-- Maneja otros errores de validaci√≥n de TS (ej: dimensi√≥n) -->
            @else if (formVianda.get('image')?.value === null && selectedFileName === null) {
            <p>
              La imagen seleccionada no cumple los requisitos (ej: dimensi√≥n m√°xima) o fue
              eliminada.
            </p>
            }
          </div>
          } @else if (!imagePreviewUrl) {
          <!-- MENSAJE REQUERIDO: Si no hay previsualizaci√≥n ni error, muestra el placeholder -->
          <p class="placeholder-info">
            No hay un archivo seleccionado. Formatos v√°lidos: jpg, webp, etc
          </p>
          } @else {
          <!-- Mensaje de √©xito si la imagen fue cargada correctamente -->
          <p class="success-message">Archivo cargado: {{ selectedFileName }}</p>
          }
        </div>
      </div>
    </div>
    <!-- Fin .image-upload-right -->
  </div>
  <!-- Fin .form-layout -->

  <!-- Boton crear vianda -->
  <button type="button" class="btn" (click)="onSubmit()" [disabled]="!formVianda.valid">
    Crear Vianda
  </button>
</form>
